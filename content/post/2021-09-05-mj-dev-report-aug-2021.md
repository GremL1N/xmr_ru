---
title: "Отчёт mj за август по разработке и интеграциям"
date: "2021-09-05"
categories:
  - "Новости"
tags:
  - "CCS"
lead: "Ежемесячный отчёт mj в ключе работы над его CCS предложением."
pager: true
toc: true
sidebar: "right"
widgets:
  - "recent"
  - "taglist"
---

Уважаемое сообщество!

Во второй половине месяца моя работа над улучшением кэша CI наконец-то была реализована, что дало ожидаемые результаты (более быстрая проверка) применительно к веткам, которые были достаточно свежими. Оказалось, что исправление будет работать только с теми ветками, которые были перенесены (синхронизированы) после объединения моей ветки. Другими словами, очистка старых, чрезмерно раздутых кэшей — это только вопрос времени, поскольку новые, минимизированные ветки, в конечном итоге навсегда заменят старые.

Чтобы немного сбалансировать разнообразие моих задач после долгой работы над CI и чтобы выявить другие проблемах кодовой базы, я выполнил статические проверки основных частей и заметил ошибки, которые могли возникать во время выхода из кошелька при определенных условиях, например, во время выхода, когда синхронизация ещё не была завершена.

Также я помог в подготовке последней версии. Я просматривал запросы PR @selsta, когда это было необходимо, а также работал над решением проблемы совместимости с последней версией библиотеки Boost 1.77. После установки Element/Matrix мне стало проще взаимодействовать с разработчиками, если сравнивать с тем, как это происходило через IRC, так как у меня 2 офиса. Поэтому я смог уделить больше времени решению текущих проблем по мере их появления.

Были открыты и другие амбициозные PR, которые мне бы хотел проверить во время отпуска, но, к сожалению, мой работодатель лишил меня отпуска, и мне придется отложить эту задачу до 2-й половины сентября, если всё будет хорошо.

Мой отчёт о состоянии дел обогатился ещё одним новшеством — деревом зависимостей в виде [изображения](http://cryptog.hopto.org/monero/health/data/8fde011db/8fde011db-dep-tree.png) и [соответствующего текста](http://cryptog.hopto.org/monero/health/data/8fde011db/8fde011db-dep-tree.txt). Конечно, это нельзя считать универсальным решением, но может пригодиться, если кто-то хочет сократить некоторые лишние зависимости. Кстати, для информации: полная версия отчёта теперь размещается по этому адресу: http://cryptog.hopto.org/monero/health.

## _Ветки_

Вот традиционный список объединённых и вновь открытых веток:

### _Новые ветки_
- Mac OSX: [исправление модульного теста bind_same_p2p_port](https://github.com/monero-project/monero/pull/7886): это первое рабочее исправление модульных тестов под Mac OSX. Если кратко, несмотря на то, что мы исправили случайный сбой теста p2p в Ubuntu, это исправление не было совместимо с OSX. Данный PR - обходной вариант для OSX, который, как было доказано, работает, но не является окончательным исправлением. Настоящее исправление потребует более глубокого изучения, но, как мне кажется, можно смело утверждать, что теперь мы знаем, где искать решение.
- Trezor: [UB: применение виртуальных методов в деструкторе Trezor](https://github.com/monero-project/monero/pull/7869): я обнаружил, что в классе Trezor присутствовали виртуальные методы, вызываемые деструктором класса. Хотя это совершенно нормально для Java и C#, в случае с C++ - это ошибка, ведущая к [неопределённому поведению](https://en.cppreference.com/w/cpp/language/ub). Методика, позволяющая избежать этого с сохранением прежних функций, заключалась в замене виртуальных методов приватными, невиртуальными методами. Деструктор, как и виртуальные методы, вызывает невиртуальные. Как я уже писал во введении, сценарий, в рамках которого это может произойти, реализуется, когда вы закрываете устройство или кошелёк, но синхронизация при этом ещё не завершена.
- Кошелёк: [UB: виртуальный метод в деструкторе WalletImpl](https://github.com/monero-project/monero/pull/7867): точно такая же история, что и в случае с UB Trezor выше. Отличается только класс.
- LMBD: [UB: виртуальный метод в деструкторе LMBD](https://github.com/monero-project/monero/pull/7859): точно такая же история, что и в случае с UB Trezor выше. Отличается только класс.
- Ledger: [членский «режим» затеняет базовый класс](https://github.com/monero-project/monero/pull/7876): статический анализ кода позволил обнаружить, что одна переменная в подклассе Ledger «затеняла» переменную с тем же именем и типом, принадлежащую базовому классу. Это может привести к неожиданному поведению, когда переменная базового класса будет изменяться, но это изменение не будет отражено в подклассе, и наоборот. Поскольку я не смог найти никого, кто бы протестировал это в Ledger, и у меня самого просто не хватало времени, чтобы вручную проверить, как использовалась переменная, и предотвратить любые побочные эффекты, мне пришлось приостановить работу над этим PR, но я вернусь к ней в ближайшее время.
- Устройство: [удаление неиспользуемого и неправильного конструктора, не используемого по умолчанию](https://github.com/monero-project/monero/pull/7875): в процессе линтинга обнаружена ещё одна ошибка. В устройстве класса присутствовал конструктор, не используемый по умолчанию, куда передавалась переменная, которая затем не использовалась для инициализации. Это нарушает принцип наименьшего удивления, то есть, конструктор не делал того, что от него ожидалось как от пользователя класса.
- EasyLogging ++: [новый анти-UB тест и распространение исключения при неправильной настройке](https://github.com/monero-project/monero/pull/7828): существовала такая ветка кода EasyLogging++, которая приводила к UB при неполной настройке. Теперь ветка выдаёт исключение, ожидая обработки на более высоком уровне. Это гарантирует, что программа поведёт себя так, как и ожидается. Я также добавил соответствующий модульный тест и убедился, что код затронут моим скриптом LCOV, который теперь доступен для всех. Решение этой задачи стало продолжением запроса «[Добавить UTests, защищающие от регрессов](https://github.com/monero-project/monero/pull/7771)».
- CMake Epee: [добавление минималистичной настройки теста +CI](https://github.com/monero-project/monero/pull/7854): я хотел помочь @UkoeHB и оживить тесты epee, чтобы они автоматически выполнялись через CI. Мне удалось сделать это сделать, но похоже, что решение скорее состоит в том, чтобы перенести тесты epee в собственную кодовую базу Monero, к которой epee не принадлежит. Несмотря на то, что решение является «конкурентоспособным» с точки зрения моего PR, я также проанализировал другой, [открытый позже PR](https://github.com/monero-project/monero/pull/7856), противоречащий моему.

### _Незначительные изменения_
- CI: [запуск make в однопоточном режиме после сбоя](https://github.com/monero-project/monero/pull/7827): простая хитрость, позволяющая получать более значимые сообщения об ошибках непосредственно в конце журнала, а не где-то ближе к концу, как это происходит сейчас. Эта путаница вызвана параллелизмом make, который работает отлично только в том случае, если всё идёт хорошо.
- CI: [использование переменной runner.os для кэширования](https://github.com/monero-project/monero/pull/7855): просто небольшая "уборка". Мы используем имена ОС, написанные вручную, в то время как они легко доступны через переменную runner.os для каждой выбранной ОС.
- CMake: [добавление отсутствующей опции SANITIZE](https://github.com/monero-project/monero/pull/7917): при попытке воспроизвести утечку памяти, о которой сообщает @selsta, я заметил, что опция, позволяющая писать код для сообщения информации о подобных утечках, на самом деле не была видна для интерактивных интерфейсов CMake, таких как ccmake или cmake-qt. Этот PR решает данную проблему. К сожалению, мне не удалось воспроизвести саму ошибку на своей машине.
- LMBD: [Предупреждения: дополнение виртуальных методов LMDB «переопределением»](https://github.com/monero-project/monero/pull/7866): Дополнение виртуальных методов LMDB переопределением помогает убедиться в том, что методы ведут себя полиморфно, как и ожидалось. До появления стандарта C++11 часто случалось так, что из-за опечаток или изменений параметров методы не переопределялись, хотя предполагалось, что происходит именно так, и это приводило к большой путанице. Сегодня компилятор CLang даже генерирует предупреждение компиляции, когда вы забываете сделать такое дополнение.

### _Объединённые ветки_
- Версия v0.17: [Исправление для Boost-1.77: Добавление отсутствующего заголовка алгоритма в i18n.cpp](https://github.com/monero-project/monero/pull/7902): Немного загадочное сообщение, полученное в результате реализации последней версии Boost 1.77, минимизирующей заголовки. Неисправный файл Monero предполагал, что заголовок <algorithm> будет включаться в заголовки Boost.
- epee: [замена постинкрементации преинкрементацией](https://github.com/monero-project/monero/pull/7850): небольшая оптимизация времени выполнения, которая в целом ничего не стоит.
- CMake: [документирование -Werror для add_c_flag_if_supported()](https://github.com/monero-project/monero/pull/7847): документально подтвержденные результаты проверки PR 7718. Предпочтительный способ, предполагающий, что всё делается в правильном порядке - устранение проблемы, добавление соответствующих изменений, чтобы они как можно скорее оказали нужное воздействие, и только потом обсуждение мелких деталей.
- CMake: [исправление ccache для FreeBSD](https://github.com/monero-project/monero/pull/7832): Возвращение к FreeBSD после анализа, выполненного @wfaressuissia. Теперь мы все довольны окончательным решением, которое представляется довольно чистым и не допускает «грязных» компромиссов. Благодаря данному исправлению и минимизации кэшей, время большей части сборок при кросс-компиляции будет занимать в общей сложности около 5 минут.

### _Оставленные (не объединённые) ветки_
- Simplewallet: [прерывание get_mnemonic_language() в случае использования отрицательного индекса](https://github.com/monero-project/monero/pull/7851): нечто обнаруженное при проведении статического анализа кода. При более глубоком рассмотрении оказалось, что это лишь ложная тревога, но только до тех пор, пока кто-нибудь не изменит соответствующий вариант реализации. Мы просто надеемся, что после отказа от этой ветки, никто этого делать не станет.

Ещё раз большое всем спасибо,
mj

---

_Источник: [Dev report Aug. 2021](https://www.reddit.com/r/Monero/comments/pi93d8/dev_report_august_2021/)_

_Перевод: [Mr. Pickles](https://t.me/v1docq47)_  
_Коррекция: [Kukima](https://t.me/Kukima)_
